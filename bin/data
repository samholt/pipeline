#!/usr/bin/env node

var fs = require("fs");
var tf = require("d3-time-format");

const RFC = tf.timeFormat("%a, %d %b %Y %H:%M:%S %Z");

let data = {
  now: Date.now(),
  nowRFC: RFC(Date.now()),
  journal: JSON.parse(fs.readFileSync(process.argv[2])),
  posts: JSON.parse(fs.readFileSync(process.argv[3]))
}

delete data.journal.committee;
delete data.journal.editors;

data.posts.forEach(p => {
  p.publishedDate = new Date(p.publishedDate);
  p.updatedDate = new Date(p.updatedDate);
  p.journal = data.journal;
  if (p.doiSuffix >= 1e5) console.error("DOI suffix overflow ", p.doiSuffix);
  p.doi = data.journal.doi + "." + ("000000" + p.doiSuffix).slice(-5);
});
data.posts.sort((a, b) => { return b.publishedDate - a.publishedDate; });

process.stdout.write(JSON.stringify(data, null, 2));